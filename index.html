<!DOCTYPE html>
<html>
<head>
	<title>Materia Abierta 2022</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="/static/css/main.css">
	<script src="static/pde/processing-1.4.1.min.js"></script>
</head>
<body loadingStage = "0">
	<div id="consent-container">
		<div id="consent-msg"></div>
	</div>
	<div id="background"></div>
	<div id="live-background">
		
		<div id="player"></div>
	</div>
	<span><a id='title' href='/'>Materia Abierta</a> / <span id="weather" class="sans">Connecting . . .</span></span><br><br><br>
	<div id="content-container">
	    <span id='intro'>
	        <i>This is the website for </i><b>The Rise of the Coyote</b>. <i>A website is (also written as web site) is a collection of web pages 
	identified by  a common domain name (<a href='/'>www.materiaabierta.com</a>) and published on a web server. This webserver is a computer situated in <a href='/media/San_pedro_atocpan.gif'>Milpa Alta, Ciudad de México</a>.</i>    
	    </span>
		<span id="content"></span> 
		<span id='outro'>
			<i>The world wide web was designed as a two-way medium, hosts and clients.</i>
		</span>
	</div>
	<div id="badge"><img src="/media/server.jpg"></div>
	<div id='clock'><canvas class='clock' datasrc="/static/pde/clock.pde"
        width="200" height="200" tabindex="0"
        style="image-rendering: optimizeQuality !important;">
    </canvas></div>

<div id="menu-container">
	<div id="menu-btn" onclick="toggleMenu()" class="sans">MENU</div>
	<div id="menu">
	</div>
</div>
<div id="geolocation" class="sans">Connecting . . .</div>
<div id="lang-toggle" class="sans"><a href="/">ES</a> / <a href="/?lang=en">EN</a></div>
<script src="/static/js/weather.js"></script>
<script src="/static/js/general.js"></script>
<script src="/static/js/liveStream.js"></script>
<script>
	
	var fullContent = '';
	var slicedContent = {};
	var match = [];
	var string_geolocation = '19°11\'33.04"N, 99°1\'23.41"W';
	var sWeather = document.getElementById('weather');
	var sGeolocation = document.getElementById('geolocation');
	var fadeInDuration = 500;
	var stageDelay = 1000;
	if(window.innerWidth > 500)
		var sizer = 220;
	else
		var sizer = 140;
	
	function nextStage(){
		let currentStage = parseInt(document.body.getAttribute('loadingStage'));
		if(currentStage == 0){
			document.body.setAttribute('loadingStage', currentStage +1);
			typewriter(string_weather, sWeather, 100, nextStage);
		}
		else
		{
			setTimeout(function(){
				if(currentStage == 1)
				{
					document.body.setAttribute('loadingStage', currentStage +1);
					setTimeout(function(){
						typewriter(string_geolocation, sGeolocation, 100, nextStage);
					}, fadeInDuration);
					
				}
				else if(currentStage == 2)
				{
					if(loadedCount == filenames.length)
						document.body.setAttribute('loadingStage', currentStage +1);
					else
						setTimeout(nextStage, 500);
				}
			}, stageDelay);		
		}
		
	}
	function typewriter(content, target, interval=500, callback=false){
		if(content.length != 0){
			let content_arr = content.split('');
			let index = 0;
			target.innerHTML = '';
			let thisInterval = setInterval(function(){
				if(content_arr[index] == ' ')
					target.innerHTML += '&nbsp;';
				else
					target.innerHTML += content_arr[index];
				index++;
				if(index == content_arr.length){
					clearInterval(thisInterval);
					if(callback)
						callback();
				}
			}, interval);
		}
		else{
			target.innerHTML = '';
			if(callback)
				callback();
		}
	}
	var loadedCount = 0;
	var request_content = [];
	var sContent = document.getElementById('content');
	var sBackground = document.getElementById('background');
	var r = document.querySelector(':root');
	var synopsis_pattern = /\<span\s*class\s*?=\s*?\"(?:.*?\s+)?subpage-synopsis(?:\s+.*?)?"\>(.*?)\<\/span\>/;
	filenames.forEach((el, i) => {
		let url = lang + '/' + el.toLowerCase() + '.html';
		request_content[i] = new XMLHttpRequest();
		request_content[i].onreadystatechange = function() {
			if(request_content[i].readyState == 4)
			{
				if (request_content[i].status === 200) {
					let match = request_content[i].responseText.match(synopsis_pattern);
					if(match && match.length > 1)
					{
						slicedContent[el] = '<span class="section-content"><a class="section-title" href="'+url+'">' + el + '</a> ' + match[1] + '</span>&nbsp;';
					}
					loadedCount++;
					if(loadedCount == filenames.length){
						filenames.forEach(function(elemt, j){
							fullContent += slicedContent[elemt];
						});
						sContent.innerHTML = fullContent;
					}
				}
			}
		}
		request_content[i].open('GET', url);
		request_content[i].send();
	});

	request_weather.send();
	
</script>
</body>
</html>
