<!DOCTYPE html>
<html>
<head>
	<title>Materia Abierta 2022</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="/static/css/main.css">
	<script src="static/pde/processing-1.4.1.min.js"></script>
</head>
<body loadingStage = "0" class="loading">
	<div id="background"></div>
	<div id="loading-msg" class="sans">Loading . . .</div>
	<div id="live-background">
		<div id="player"></div>
	</div>
	<span><a id='title' onclick="requestPage('home')">Materia Abierta</a> / <span id="weather" class="sans">Connecting . . .</span></span><br><br><br>
	<div id="content-container">
	    <span id='intro'>
	        <i>This is the website for </i><b>The Rise of the Coyote</b>. <i>A website is (also written as web site) is a collection of web pages 
	identified by  a common domain name (<a href='/'>www.materiaabierta.com</a>) and published on a web server. This webserver is a computer situated in <a href='/media/San_pedro_atocpan.gif'>Milpa Alta, Ciudad de México</a>.</i>    
	    </span>
		<span id="content"></span> 
		<span id='outro'>
			<i>The world wide web was designed as a two-way medium, hosts and clients.</i>
		</span>
	</div>
	<div id="badge"><img src="/media/server.jpg"></div>
	<div id='clock'><canvas class='clock' datasrc="/static/pde/clock.pde"
        width="200" height="200" tabindex="0"
        style="image-rendering: optimizeQuality !important;">
    </canvas></div>

<div id="menu-container">
	<div id="menu-btn" onclick="toggleMenu()" class="sans">MENU</div>
	<div id="menu">
	</div>
</div>
<div id="geolocation" class="sans">Connecting . . .</div>
<div id="lang-toggle" class="sans"><a href="/">ES</a> / <a href="/?lang=en">EN</a></div>
<script src="/static/js/weather.js"></script>
<!-- <script src="/static/js/general.js"></script> -->

<script>
	var searchParams = new URLSearchParams(window.location.search);
	var lang = searchParams.get('lang') !== null ? searchParams.get('lang') : 'es';
	var page = searchParams.get('page') !== null ? searchParams.get('page') : 'home';
	var isTest = searchParams.get('test') !== null;

	var filenames_all = {
		'en':[
			'Open Call 2022',
			'The Rise of the Coyote',
			'Milpa Alta and Xochimilco',
			'Curatorial text',
			'Program',
			'Tutors',
			'Participants',
			'Cost',
			'Calendar',
			'Application',
			'Credits',
			'Contact',
			'Bios'
		],
		'es':[
			'Convocatoria 2022',
			'La rebelión del coyote',
			'Milpa Alta y Xochimilco',
			'Resumen curatorial',
			'Programa',
			'Docentes',
			'Participantes',
			'Costo',
			'Calendario',
			'Aplicación',
			'Créditos',
			'Contacto',
			'Semblanzas'
		]
	};
	var filenames = filenames_all[lang];

	// menu
	function toggleMenu(){
		document.body.classList.toggle('viewing-menu');
	}
	var sMenu = document.getElementById('menu');
	if(sMenu)
	{
		filenames.forEach((el, i) => {
			let menuItem = document.createElement('DIV');
			menuItem.classList = 'menu-item sans';
			let menuItemLink = document.createElement('A');
			menuItemLink.innerText = el;
			menuItemLink.addEventListener('click', function(){
				requestPage(el);
				toggleMenu();
			});
			menuItem.appendChild(menuItemLink);
			sMenu.appendChild(menuItem);
		});
	}
	else console.log('#menu not found');

	// support of xmlhttprequest
	var bActiveX;
	try {
	  new ActiveXObject('Microsoft.XMLHTTP');
	  bActiveX = true;
	}
	catch(e) {
	  bActiveX = false;
	}

	var sContent_container = document.getElementById('content-container');
	var sContent = document.getElementById('content');
	var sBackground = document.getElementById('background');
	var sWeather = document.getElementById('weather');
	var sGeolocation = document.getElementById('geolocation');

	var homeContent_full = '';
	var homeContent_sliced = {};
	var subpageContent = {};
	var string_geolocation = '19°11\'33.04"N, 99°1\'23.41"W';
	
	var match = [];

	var fadeInDuration = 500;
	var stageDelay = 1000;
	var typingInterval = isTest ? 10 : 100;
	var typewriterIntervalObj = null;
	if(window.innerWidth > 500)
		var sizer = 220;
	else
		var sizer = 140;

	var loadedCount = 0;
	var request_content = [];

	var synopsis_pattern = /\<span\s*class\s*?=\s*?\"(?:.*?\s+)?subpage-synopsis(?:\s+.*?)?"\>(.*?)\<\/span\>/;

	function requestPage(target="home"){

		if (window.XMLHttpRequest || bActiveX) { // IE7+, FF and Chrome

			let target_lowercased = target.toLowerCase();
			if(target == 'home')
			{
				if(homeContent_full !== ''){
					sContent_container.classList.add('transition');
					sContent.innerHTML = homeContent_full;
					window.history.pushState({"html":homeContent_full, "lang":lang, "page":page},"", '/?lang='+lang);
					setTimeout(function(){
            			sContent_container.classList.remove('transition');
            			typewriter(string_weather, sWeather, typingInterval);
            		}, 0);
				}
				else
				{
					sContent_container.classList.add('transition');
					filenames.forEach((el, i) => {
						let url = lang + '/' + el.toLowerCase() + '.html';
						request_content[i] = XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
						request_content[i].onreadystatechange = function() {
							if(request_content[i].readyState == 4)
							{
								if (request_content[i].status === 200) {
									let match = request_content[i].responseText.match(synopsis_pattern);
									if(match && match.length > 1)
									{
										homeContent_sliced[el] = '<span class="section-content"><a class="section-title" onclick="requestPage(\''+el+'\')">' + el + '</a> ' + match[1] + '</span>&nbsp;';
									}
									loadedCount++;
									if(loadedCount == filenames.length){
										filenames.forEach(function(elemt, j){
											homeContent_full += homeContent_sliced[elemt];
										});
										sContent.innerHTML = homeContent_full;
										// homeContent_full = document.getElementById('intro').innerHTML + homeContent_full;
										// homeContent_full += document.getElementById('outro').innerHTML;
										window.history.pushState({"html":homeContent_full, "lang":lang, "page":page},"", '/?lang='+lang);
										setTimeout(function(){
					            			sContent_container.classList.remove('transition');
					            			typewriter(string_weather, sWeather, typingInterval);
					            		}, 0);
									}
								}
							}
						}
						request_content[i].open('GET', url);
						request_content[i].send();
					});
				}
				document.body.classList.remove('subpage');
				
			}
			else
			{
				let path = '/' + lang + '/' + target_lowercased + '.html';
				let pathUrl = isTest ? '/?lang='+lang+'&page='+target+'&test' : '/?lang='+lang+'&page='+target;
				
				var request_page = XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
				request_page.onreadystatechange = function(){
					if (request_page.readyState === 4) {
						if (request_page.status === 200) { 
							try{
				                if(request_page.responseText)
			                	{
			                		sContent_container.classList.add('transition');
			                		sContent.innerHTML = request_page.responseText;
			                		window.history.pushState({"html":request_page.responseText, "lang":lang, "page":page},"", pathUrl);
			                		setTimeout(function(){
			                			sContent_container.classList.remove('transition');
			                			typewriter(target, sWeather, typingInterval);
			                			document.body.classList.add('subpage');
			                		}, 0);
			                	}
							}
							catch(err){
								console.log(err);
							}
						}
						// else console.log('request_page.status !== 200');
					}
					// else console.log('request_page.readyState !== 4');
				};
				request_page.open('GET', path);
				request_page.send();
			}
			page = target_lowercased;
		}
	}
	function nextStage(){
		let currentStage = parseInt(document.body.getAttribute('loadingStage'));
		if(currentStage == 0){
			document.body.setAttribute('loadingStage', currentStage +1);
			if(page === 'home')
				typewriter(string_weather, sWeather, typingInterval, nextStage);
			else
				typewriter(page, sWeather, typingInterval, nextStage);
		}
		else
		{
			setTimeout(function(){
				if(currentStage == 1)
				{
					document.body.setAttribute('loadingStage', currentStage +1);
					setTimeout(function(){
						typewriter(string_geolocation, sGeolocation, typingInterval, nextStage);
					}, fadeInDuration);
					
				}
				else if(currentStage == 2)
				{
					if(page !== 'home' || loadedCount == filenames.length)
						document.body.setAttribute('loadingStage', currentStage +1);
					else
						setTimeout(nextStage, 500);
				}
			}, stageDelay);		
		}
		
	}
	function typewriter(content, target, interval=100, callback=false){
		if(content.length != 0){
			if(typewriterIntervalObj != null)
			{
				clearInterval(typewriterIntervalObj);
				typewriterIntervalObj = null;
			}
			let content_arr = content.split('');
			let index = 0;
			target.innerHTML = '';
			typewriterIntervalObj = setInterval(function(){
				if(content_arr[index] == ' ')
					target.innerHTML += '&nbsp;';
				else
					target.innerHTML += content_arr[index];
				index++;
				if(index == content_arr.length){
					clearInterval(typewriterIntervalObj);
					if(callback)
						callback();
				}
			}, interval);
		}
		else{
			target.innerHTML = '';
			if(callback)
				callback();
		}
	}

	requestPage(page);
	window.addEventListener('popstate', function(e){
		// console.log('onpopstate');
		// console.log(e);
	    if(e.state){
	    	// console.log(e);
	        sContent.innerHTML = e.state.html;
	        lang = e.state.lang;
	        page = e.state.page;
	        console.log('page: ');
	        console.log(page);
	        console.log('html: ');
	        console.log(e.state.html);
	        if(page !== 'home'){
	        	body.classList.add('subpage');
	        	typewriter(page, sWeather, typingInterval);
	        }
	        else{
	        	body.classList.remove('subpage');
	        	typewriter(string_weather, sWeather, typingInterval);
	        }
	    }
	});
	var r = document.querySelector(':root');
	request_weather.send();

</script>
<script src="/static/js/liveStream.js"></script>
</body>
</html>
